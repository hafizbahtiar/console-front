# Server Setup Guide - Frontend (Next.js)

## Caddy Reverse Proxy Configuration

This guide explains how to set up the frontend with Caddy reverse proxy using the domain `console.hafizbahtiar.com`.

### Prerequisites

- Caddy installed and running
- Domain `console.hafizbahtiar.com` pointing to your server
- Frontend running on port `3000` (default)
- Backend running on port `8000` (default)

### Caddyfile Configuration

The Caddyfile should be configured to route:
- `/api/*` → Backend (localhost:8000)
- All other routes → Frontend (localhost:3000)

**Complete Caddyfile** (see backend docs for full details):

```caddy
console.hafizbahtiar.com {
    encode gzip

    # Backend API routes
    handle_path /api* {
        reverse_proxy localhost:8000
    }

    # WebSocket connections
    handle_path /socket.io* {
        reverse_proxy localhost:8000
    }

    # Frontend (Next.js)
    handle {
        reverse_proxy localhost:3000
    }

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000;"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "no-referrer-when-downgrade"
    }
}
```

This setup ensures:
- Frontend at `https://console.hafizbahtiar.com/`
- Backend API at `https://console.hafizbahtiar.com/api/v1/`
- All image URLs use the same domain

### Environment Variables

Create or update your `.env.local` file in the frontend root:

```bash
# API URL - use your domain (or use relative path)
NEXT_PUBLIC_API_URL=https://console.hafizbahtiar.com/api/v1

# Alternative: Use relative path (recommended when on same domain)
# NEXT_PUBLIC_API_URL=/api/v1
```

**Note:** Since both frontend and backend are on the same domain, you can use a relative path `/api/v1` instead of the full URL. This makes the setup more flexible and works automatically with your domain.

### Next.js Configuration

The `next.config.ts` should work with the default configuration. No changes needed unless you have specific requirements.

### Building and Starting

1. **Build the project:**
   ```bash
   npm run build
   ```

2. **Start the production server:**
   ```bash
   npm start
   ```

   Or use PM2 for process management:
   ```bash
   pm2 start npm --name "console-front" -- start
   ```

### Port Configuration

The frontend runs on port `3000` by default. To change it:

1. **Using environment variable:**
   ```bash
   PORT=3000 npm start
   ```

2. **Or update package.json:**
   ```json
   {
     "scripts": {
       "start": "next start -p 3000"
     }
   }
   ```

### Verifying the Setup

1. **Check frontend:**
   - Open `https://console.hafizbahtiar.com` in your browser
   - Should see the frontend application

2. **Check API calls:**
   - Open browser DevTools → Network tab
   - Verify API requests go to `https://console.hafizbahtiar.com/api/v1/...`

3. **Check image URLs:**
   - Upload an image or view existing images
   - Verify image URLs use `https://console.hafizbahtiar.com/api/v1/uploads/...`

### Important Notes

1. **API URL**: The frontend uses `NEXT_PUBLIC_API_URL` to make API calls. You can use:
   - Full URL: `https://console.hafizbahtiar.com/api/v1` (explicit)
   - Relative path: `/api/v1` (recommended - automatically uses current domain)

2. **API Calls**: When using relative paths, your API client will automatically use the current domain:
   ```typescript
   // This will work with relative paths
   const res = await fetch('/api/v1/users');
   ```

3. **CORS**: The backend must have `CORS_ORIGIN` set to include `https://console.hafizbahtiar.com`. Since both are on the same domain, CORS should work seamlessly.

4. **HTTPS**: Caddy automatically handles SSL/TLS certificates via Let's Encrypt.

5. **Image URLs**: Image URLs are generated by the backend. Ensure the backend's `UPLOAD_PUBLIC_URL` is set to `https://console.hafizbahtiar.com/api/v1/uploads`.

### Troubleshooting

- **API calls failing**: Check `NEXT_PUBLIC_API_URL` is set correctly
- **CORS errors**: Verify backend `CORS_ORIGIN` includes your domain
- **Images not loading**: Check backend `UPLOAD_PUBLIC_URL` configuration
- **502 Bad Gateway**: Verify frontend is running on port 3000

